name: Build and Upload Artifact

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact_name: ${{ steps.vars.outputs.artifact_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      - name: Get version and commit hash
        id: vars
        run: |
          VERSION=$(node -p "require('./package.json').version")
          GIT_HASH=$(git rev-parse --short=7 HEAD)
          ARTIFACT="dist-v${VERSION}-${GIT_HASH}.tar.gz"
          echo "artifact_name=$ARTIFACT" >> $GITHUB_OUTPUT

      - name: Archive production build
        run: tar -czf "${{ steps.vars.outputs.artifact_name }}" dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.vars.outputs.artifact_name }}
          path: ${{ steps.vars.outputs.artifact_name }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: ./

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DROPLET_KEY }}

      - name: Copy artifact to droplet
        run: |
          scp -o StrictHostKeyChecking=no ${{ needs.build.outputs.artifact_name }} ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }}:${{ secrets.DROPLET_DEPLOY_PATH }}

      - name: Deploy on droplet
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.DROPLET_USER }}@${{ secrets.DROPLET_HOST }} << 'EOF'
            cd ${{ secrets.DROPLET_DEPLOY_PATH }}
            ARTIFACT="${{ needs.build.outputs.artifact_name }}"
            DIR="${ARTIFACT%.tar.gz}"
            mkdir -p "$DIR"
            tar -xzf "$ARTIFACT" -C "$DIR"
            rm -f dist
            ln -sfn "$DIR/dist" dist
            # Optionally: rm "$ARTIFACT"
          EOF
